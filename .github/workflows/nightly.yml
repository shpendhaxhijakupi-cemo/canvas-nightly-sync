name: Nightly Canvas Export (Courses Only)

on:
  schedule:
    - cron: "0 2 * * *"   # daily at 02:00 UTC
  workflow_dispatch:

jobs:
  run-export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # requests is used by the inline exporter below
          pip install requests

      # (Optional) still run your summary exporter if you want the student sheet too
      - name: Run your summary exporter (optional)
        continue-on-error: true
        env:
          API_URL:  ${{ secrets.CANVAS_API_URL }}
          API_KEY:  ${{ secrets.CANVAS_API_KEY }}
          IDS:      ${{ secrets.INCLUDE_CANVAS_IDS }}
        run: |
          python canvas_export_enrollment_b2c_final_2.py \
            --api-url "$API_URL" \
            --api-key "$API_KEY" \
            --account-id self \
            --out "Students_AllInOne.csv" \
            --include-assignments \
            --include-canvas-ids "$IDS"

      # === Generate the PER-COURSE CSV directly from Canvas ===
      - name: Build per-course CSV for Airtable
        env:
          API_URL:  ${{ secrets.CANVAS_API_URL }}
          API_KEY:  ${{ secrets.CANVAS_API_KEY }}
          IDS:      ${{ secrets.INCLUDE_CANVAS_IDS }}   # e.g. "796,797,884"
        run: |
          python - <<'PY'
          import csv, os, sys, time
          from datetime import datetime
          import requests

          API_URL = os.environ["API_URL"].rstrip("/")
          API_KEY = os.environ["API_KEY"]
          IDS = [s.strip() for s in os.environ.get("IDS","").split(",") if s.strip()]
          HEADERS = {"Authorization": f"Bearer {API_KEY}"}
          PER_PAGE = 100
          START_MONTH = 8  # school year start (Aug)

          def iso(dt):
              return datetime.fromisoformat(dt.replace("Z","+00:00")) if dt else None

          def school_year(dt):
              if not dt: return ""
              y = dt.year
              return f"{y-1}-{y}" if dt.month < START_MONTH else f"{y}-{y+1}"

          def paged(url, params=None):
              params = dict(params or {})
              while True:
                  r = requests.get(url, headers=HEADERS, params=params, timeout=60)
                  if r.status_code in (429,500,502,503,504):
                      time.sleep(1); continue
                  r.raise_for_status()
                  data = r.json()
                  if isinstance(data, list):
                      for x in data: yield x
                  else:
                      yield data
                  link = r.headers.get("Link","")
                  nxt = None
                  for part in link.split(","):
                      if 'rel="next"' in part:
                          nxt = part[part.find("<")+1: part.find(">")]
                          break
                  if not nxt: break
                  url, params = nxt, None

          # Write output
          out = "Canvas_Enrollment_Courses.csv"
          with open(out, "w", newline="", encoding="utf-8") as f:
              w = csv.writer(f)
              w.writerow([
                  "Enrollment Course Key","Enrollment Key","Student Canvas ID","Student Name",
                  "School Year","Course ID","Course Code","Course Name",
                  "Course Start Date","Course End Date","Assigned Teachers",
                  "Current Score","Final Score","Passed?"
              ])

              # iterate students
              for uid in IDS:
                  try:
                      # get basic name
                      prof = requests.get(f"{API_URL}/users/{uid}/profile", headers=HEADERS, timeout=30)
                      if prof.ok:
                          name = (prof.json().get("name") or "").strip()
                      else:
                          name = f"User {uid}"

                      # enrollments with grades
                      for enr in paged(f"{API_URL}/users/{uid}/enrollments",
                                       {"type[]":"StudentEnrollment","include[]":"grades","per_page":PER_PAGE}):
                          cid = enr.get("course_id")
                          if not cid: continue
                          grades = enr.get("grades") or {}
                          cur = grades.get("current_score")
                          fin = grades.get("final_score")

                          # course info
                          c = requests.get(f"{API_URL}/courses/{cid}", headers=HEADERS, timeout=60)
                          if not c.ok: 
                              course = {}
                          else:
                              course = c.json()

                          cstart = iso(course.get("start_at")) or iso(enr.get("start_at"))
                          cend   = iso(course.get("end_at")) or iso(enr.get("end_at"))
                          sy = school_year(cstart or iso(enr.get("created_at")))

                          # teachers
                          tnames = []
                          for t in paged(f"{API_URL}/courses/{cid}/enrollments",
                                         {"type[]":"TeacherEnrollment","per_page":PER_PAGE}):
                              u = t.get("user") or {}
                              nm = u.get("name") or u.get("sortable_name")
                              if nm: tnames.append(nm)
                          tnames = sorted(set(tnames))
                          teachers = ", ".join(tnames)

                          key = f"{uid}-{sy}-{cid}"
                          enr_key = f"{uid}-{sy}"

                          passed = ""
                          try:
                              if fin is not None:
                                  passed = "Yes" if float(fin) >= 60.0 else "No"
                          except Exception:
                              passed = ""

                          w.writerow([
                              key, enr_key, uid, name, sy, cid,
                              course.get("course_code") or "",
                              course.get("name") or "",
                              cstart.isoformat() if cstart else "",
                              cend.isoformat() if cend else "",
                              teachers,
                              cur if cur is not None else "",
                              fin if fin is not None else "",
                              passed
                          ])
                  except Exception as e:
                      print(f"[warn] failed student {uid}: {e}", file=sys.stderr)
                      continue

          print("[ok] Wrote Canvas_Enrollment_Courses.csv")
          PY

      - name: Upload CSVs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: canvas-csvs
          path: |
            *.csv

      - name: Upsert Enrollment Courses â†’ Airtable
        env:
          AIRTABLE_PAT:        ${{ secrets.AIRTABLE_PAT }}
          AIRTABLE_BASE_ID:    ${{ secrets.AIRTABLE_BASE_ID }}
          AIRTABLE_TABLE_NAME: ${{ secrets.AIRTABLE_TABLE_NAME }}  # "B2C Courses Enrollment"
        run: |
          python airtable_upsert.py \
            --base "$AIRTABLE_BASE_ID" \
            --table "$AIRTABLE_TABLE_NAME" \
            --token "$AIRTABLE_PAT" \
            --csv "Canvas_Enrollment_Courses.csv" \
            --unique-field "Enrollment Course Key" \
            --typecast
